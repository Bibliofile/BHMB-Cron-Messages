{"version":3,"file":"bundle.js","sources":["../src/index.ts"],"sourcesContent":["import { MessageBot } from '@bhmb/bot'\r\nimport { UIExtensionExports } from '@bhmb/ui'\r\n\r\n\r\n// message is a string, you can also load .css and .html files like this\r\nimport html from './tab.html'\r\n\r\ninterface Message {\r\n  minutes: string\r\n  message: string\r\n}\r\n\r\nfunction findParent(className: string, element: HTMLElement | null): HTMLElement {\r\n  while (element && !element.classList.contains(className)) element = element.parentElement\r\n  if (element) return element\r\n  throw new Error('No root member found.')\r\n}\r\n\r\nMessageBot.registerExtension('bibliofile/cron', (ex) => {\r\n  const getMessages = () => ex.storage.get<Message[]>('messages', [])\r\n\r\n  let timeout: number\r\n  function listener() {\r\n    let minute = new Date().getMinutes()\r\n    getMessages().forEach(function (msg) {\r\n      let msgMinutes = msg.minutes.replace(/\\s/g, '').split(',')\r\n      msgMinutes.forEach(min => {\r\n        if (+min == minute) {\r\n          ex.bot.send(msg.message)\r\n        }\r\n      })\r\n    })\r\n\r\n    timeout = setTimeout(listener, 60 * 1000)\r\n  }\r\n  listener()\r\n\r\n  ex.uninstall = () => clearTimeout(timeout)\r\n\r\n  // Browser only\r\n  const ui = ex.bot.getExports('ui') as UIExtensionExports | undefined\r\n  if (!ui) return\r\n\r\n  let tab = ui.addTab('Cron', 'messages')\r\n  tab.innerHTML = html\r\n\r\n  let container = tab.querySelector('.messages-container') as HTMLElement\r\n\r\n  function saveConfig() {\r\n    let boxes = Array.from(container.children)\r\n    let messages: Message[] = []\r\n    boxes.forEach(function (container) {\r\n      let minutes = container.querySelector('input')!\r\n      let message = container.querySelector('.m') as HTMLInputElement\r\n      if (minutes.validity.valid && minutes.value.length && message.value.length) {\r\n        messages.push({ message: message.value, minutes: minutes.value })\r\n      }\r\n    })\r\n\r\n    ex.storage.set('messages', messages)\r\n  }\r\n  tab.addEventListener('input', saveConfig)\r\n\r\n  container.addEventListener('click', function (event) {\r\n    const target = event.target as HTMLElement\r\n    if (target.tagName == 'BUTTON') {\r\n      target.parentElement\r\n      ui.alert('Really delete this message?', [\r\n        { text: 'Delete', style: 'is-danger' },\r\n        { text: 'Cancel' }\r\n      ], function (response) {\r\n        if (response == 'Delete') {\r\n          findParent('box', target).remove()\r\n          saveConfig()\r\n        }\r\n      })\r\n      event.stopPropagation()\r\n    }\r\n  })\r\n\r\n  tab.querySelector('.button')!.addEventListener('click', function () {\r\n    addMessage()\r\n  })\r\n\r\n  let template = tab.querySelector('template')!\r\n  let addMessage = (msg: Partial<Message> = {}) => {\r\n    ui.buildTemplate(template, container, [\r\n      { selector: 'input', value: msg.minutes || 0 },\r\n      { selector: '.m', value: msg.message || '' },\r\n    ])\r\n  }\r\n\r\n  getMessages().forEach(addMessage)\r\n})\r\n"],"names":["MessageBot"],"mappings":"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"}